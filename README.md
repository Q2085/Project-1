# ⛅ 臺灣梅雨季降雨事件之分析

## 1. 專案概述

這個專案將利用CNN（卷積神經網路）模型，來對台灣梅雨季節期間降雨事件的強度進行分類。透過輸入氣象參數，預測未來24小時的降雨強度區間。

為了評估模型的表現及可靠性，本專案透過可解釋性方法（Explainable AI, XAI）進行分析，嘗試找出模型可能存在的缺陷並提出建議。也簡單討論 XAI 詮釋結果的物理意義。

## 2. 工具與資料集

### 2.1 主要分析工具

- 皆以 Python 進行繪圖與分析
- 機器學習框架使用 PyTorch
- XAI 部分使用到 SHAP 套件

### 2.2 資料集

- **ERA5 Hourly Data**
ERA5是歐洲中期天氣預報中心（ECMRW）的再分析（Reanalysis）資料。再分析資料是將過往觀測資料整合進氣象預報模型中再產出，以提供長期、連貫、容易使用的氣候資料集。
- **臺灣大氣事件資料庫**
由文化大學蘇世穎教授實驗室建立的資料庫，紀錄並分類臺灣每日的天氣狀況。主要類別包括：鋒面、颱風、寒潮、東北風、西南風事件等。
- **TCCIP 臺灣日雨量網格化資料**
TCCIP（臺灣氣候變遷推估資訊與調適知識平台計畫）統整歷史雨量測站資料，並進行均一化、補遺、網格化，提供容易分析使用的臺灣日雨量資料。

## 3. 建立預測模型

### 3.1 資料前處理

- **Input｜ERA5 Hourly Data**
選取「每日0時、10°N – 30°N,  110°E – 127°E、5個高度層場」的7個氣象參數當作訓練資料：
`溫度`、`經向風速`、`緯向風速`、`上升速度`、`輻散`、`比濕`、`重力位高度`（相當於氣壓）
其中，將5個高度層（1000, 850, 700, 500, 200 hPa）的比濕積分轉換成`可降水量`，因此每筆訓練資料由31個2維變數組成。
    - 💡 可降水量（Precipitable water, PW）
        
        假設把一個地方上空的所有水氣凝結並轉換成雨水後，等同的雨量值大小
        
- **Filtering｜臺灣大氣事件資料庫**
透過此資料集篩選出 1980～2020年梅雨季（5、6月份）所有鋒面事件的日期，共得到940筆，並使用這些日期0時的ERA5資料進行訓練。
- **Labeling｜TCCIP 臺灣日雨量網格化資料**
本專案採用每日臺灣雨量的最大值作為降雨強度區間的分類依據，並將降雨強度主觀劃分為四類：`<40 mm`、`40-80 mm`、`80-145 mm`、`>145 mm`。這些界定各類別的雨量閾值，是設計成讓各類別的資料量盡可能均衡。

### 3.2 模型設計

![本專題所採用的CNN模型設計，共有3層 Convolution layer 與2層 Max-pool layer](/pic/CNN.jpg)

本專題所採用的CNN模型設計，共有3層 Convolution layer 與2層 Max-pool layer

### 3.3 訓練結果

訓練過程中，樣本被切分為4份並採用 K-Fold 交叉驗證。隨後，將4次驗證集的預測結果相加，並一併繪製於下圖的混淆矩陣中。

![image.png](/pic/image.png)

圖表顯示，在所有梅雨季的鋒面事件中，CNN模型能夠較準確地預測兩種極端情況：大雨（>145mm）或幾乎無雨（<40mm）。然而，對於中等強度的降雨，模型的預測則較為混淆。

不過，由於這裡採用的標籤方式較為簡化，僅以雨量最大值來代表降雨強度，犧牲了降雨在空間型態上的複雜性，模型的表現可能會多少受到這種簡化方法的影響。

## 4. 可解釋性分析

### 4.1 Expected Gradient

本專案使用 `shap.GradientExplainer` 進行模型的可解釋性分析，它是透過 ”Expected Gradient” 方法，來量化樣本中各特徵（Feature）的重要性。

- 💡  **Expected Gradient**
    
    在可解釋性方法中，「基於梯度（Gradient）的方法」，其核心概念是計算輸入值的微小變動對預測結果的影響，即輸出值對輸入值的梯度。然而，由於梯度值可能隨特徵輸入值的大小顯著變化，單點梯度計算可能無法準確反映特徵的重要性。
    
    為解決這個問題，研究者提出了 ”Integrated Gradient” 方法。以卷積神經網路（CNN）為例，此方法首先選定一個基準（Baseline），比如全黑圖片，然後將此基準圖片以不同「透明度」與輸入圖片進行內插，並把這個過程中，輸出值對輸入值的梯度積分起來。
    
    ![圖片取自：[https://github.com/d246810g2000/Explainable_AI/blob/main/DL/02_Gradient-Based.ipynb](https://github.com/d246810g2000/Explainable_AI/blob/main/DL/02_Gradient-Based.ipynb)](/pic/image 1.png)
    
    圖片取自：[https://github.com/d246810g2000/Explainable_AI/blob/main/DL/02_Gradient-Based.ipynb](https://github.com/d246810g2000/Explainable_AI/blob/main/DL/02_Gradient-Based.ipynb)
    
    然而，Integrated Gradient 方法仍存在一些問題。例如，若以黑色圖片作為基準，那麼當輸入圖片中含有黑色部分時，這些區域就不會被納入積分計算，使該區域的重要性被低估。
    
    在 Expected Gradient 方法中，將不再沿著給定基準與輸入圖片內差的路徑積分。相對的，可以想像在整個訓練集中，每個像素的數值大小會有各自的分布，而 Expected Gradient 方法便會參照這個分布來進行積分。
    

### 4.2 藉由模型認識強降雨特徵

![U：緯向（東西向）風速、V：經向（南北向）風速、PW：可降水量、Z：重力位高度、D：輻散、W：垂直速度。
數字代表高度場，比如 U1000 指的是 1000 百帕（hPa）的緯向風速](/pic/image 2.png)

U：緯向（東西向）風速、V：經向（南北向）風速、PW：可降水量、Z：重力位高度、D：輻散、W：垂直速度。
數字代表高度場，比如 U1000 指的是 1000 百帕（hPa）的緯向風速

上圖是針對正確預測＞145mm 的事件，使用 Expected Gradient 計算出對預測結果有最大貢獻的8項氣象參數。其中，第1、2、6、7名都是低層風場的資訊，第3名是可降水量，其次則是 1000百帕的高度場和200百帕的輻散場。接著，我們可以繪製這些樣本的合成平均，來進一步認識模型如何利用各個氣象參數的空間特性進行預測。

![正確預測＞145mm 事件的氣象參數，以及對應 Expected Gradient 詮釋的合成平均](/pic/image 3.png)

正確預測＞145mm 事件的氣象參數，以及對應 Expected Gradient 詮釋的合成平均

這四張圖中，左半邊繪製選定氣象參數的合成平均，右半邊則是對應的「重要性」詮釋結果。

在顯著降水的梅雨事件中，低層（700百帕以下）常伴隨強勁的西南風。根據詮釋結果，CNN模型也將低層風場視為最重要的預測因素。平均而言，臺灣西南海域是模型做出判斷的主要區域（左上圖）。

對於可降水量（右上圖）和高層輻散場（右下圖），模型的預測主要集中在臺灣周圍區域。當高層風場出現輻散時，其下方的空氣會補償性上升，形成有利對流發展的條件。反過來說，當對流上升至高空後，因無法突破穩定的平流層，也必須向周圍輻散。兩者可互為因果。

至於1000百帕的高度場（左下圖），除了臺灣本島外，臺灣海峽延伸至福建沿海一帶也出較高的重要性。較低的高度場反映臺灣位處於低壓環境之中。

### 4.3 分析模型表現

3.3節呈現的混淆矩陣中，有8個強降雨事件（＞145mm）被模型誤判為幾乎無雨（＜40mm）。經檢視後發現，其中4個事件的降雨熱區位於東部及北海岸（下圖 ①～④），另外有3個事件的降雨熱區位於西北部（⑤～⑦），與多數梅雨鋒面降雨集中在中南部的型態不盡相同。

東部降雨的4個案例中，1998年5月30日和1986年5月26日（①、②）都是受到熱帶性低氣壓的影響，這類降雨並不在原先設定的訓練目標內，以下討論先將其排除在外。

![image.png](/pic/image 4.png)

![8個被模型誤判為幾乎無雨（＜40mm）的強降雨事件（＞145mm）](/pic/image 5.png)

8個被模型誤判為幾乎無雨（＜40mm）的強降雨事件（＞145mm）

我們可以透過可解釋性方法，來了解可能是哪些特徵，讓模型做出錯誤決策。以⑥、⑦號降雨事件為例，下圖繪製了這兩個案例中，各個氣象參數對於預測 >145mm 的貢獻。圖片顯示，低層風場資訊（如U850）以及可降水量（PW），對預測分類 >145mm 有負貢獻，是讓傾向於讓模型誤判的主要參數。

![image.png](/pic/image 6.png)

進一步畫出這些氣象參數，以及對應的重要性貢獻空間分布如下。左半邊繪製850百帕天氣圖、中間繪製可降水量（PW）的重要性貢獻、右半邊繪製850百帕緯向風（U850）的重要性貢獻。

![image.png](/pic/image 7.png)

![左：850 百帕天氣圖，顏色代表可降水量、等值線代表重力位高度
中：可降水量對於預測 >145mm 的重要性貢獻
右：850 百帕緯向風對於預測 >145mm 的重要性貢獻](/pic/image 8.png)

左：850 百帕天氣圖，顏色代表可降水量、等值線代表重力位高度
中：可降水量對於預測 >145mm 的重要性貢獻
右：850 百帕緯向風對於預測 >145mm 的重要性貢獻

在這兩個案例中，可以觀察到伴隨大量水氣的低層噴流（即風速快的氣流）不完全直接指向臺灣，其位置相對其他 >145mm 之事件（可對照下圖）皆略為偏北。再參考重要性貢獻的空間分布圖，兩事件噴流的位置，皆與緯向風「負貢獻」區域高度重疊。而噴流南側相對乾燥的區域，則與可降水量「負貢獻」的區域重疊。

![左：所有正確預測 >145mm 事件之日累積雨量合成平均
右：所有正確預測 >145mm 事件之850百帕天氣圖合成平均。顏色代表可降水量](/pic/image 9.png)

左：所有正確預測 >145mm 事件之日累積雨量合成平均
右：所有正確預測 >145mm 事件之850百帕天氣圖合成平均。顏色代表可降水量

臺灣擁有複雜的地形，因此即便風場等環境條件出現些微變化，降雨型態也可能截然不同。在大多數伴隨強降雨的梅雨鋒面事件中，中南部山區作為迎風面，往往會出現較大雨勢。模型的學習對象也主要以這類事件為主。然而，在許多嚴重誤報的案例中，由於暖濕低層噴流或鋒面位置偏北，導致模型預測出現偏差。

如先前所述，僅以雨量最大值來代表降雨強度的標籤方式，忽略了不同降雨空間型態的差異。這些不同空間型態的降雨，對應的環境條件也有所不同。若希望在有限的資料量下提升模型表現，相信探索能夠反映降水空間型態差異的訓練方式，將會是有效改善的方向。

## 5. 總結

- 本專案成功訓練了預測梅雨事件降雨強度的CNN分類模型
- 本專案展示了，XAI方法不僅能讓我們深入理解模型的判斷依據，更可以協助我們找尋模型存在的缺陷，替未來模型的改善提供明確的方向
- XAI分析表明，模型對強降雨事件的預測依據，與傳統預報方法頗為吻合，例如兩者皆重視低層噴流與高層輻散的重要性
- 分析模型嚴重誤報的樣本後，發現這些樣本的背景環境條件，與其它強降雨事件確實有所差異。XAI方法驗證並量化了這樣的相異環境，可對預測結果帶來的影響。
- 基於分析結果，專案提出建議如下：① 將不同環境條件下的降雨類型納入訓練，或 ② 探索能夠反映降水空間型態差異的訓練方法
